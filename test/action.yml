name: 'Test'
description: >
  Runs tests for a single language context item. Receives one entry from the
  pipeline-context matrix produced by detect-contexts, sets up the appropriate
  toolchain, and executes the test command for that language.
  The matrix fan-out (strategy.matrix) must be declared in the calling workflow;
  this action handles the per-item setup and execution.
inputs:
  pipeline-context:
    description: >
      A single matrix item (JSON string) from detect-contexts
      pipeline-context.matrix. Contains: language, version, context, name,
      and optionally command.
      Pass with: pipeline-context: ${{ toJson(matrix) }}
    required: true

runs:
  using: "composite"
  steps:
    # ── Parse JSON into individual step outputs ───────────────────────────────
    # fromJson() is not permitted in composite action step `if:` conditions, so
    # we extract all fields here and reference `steps.ctx.outputs.*` below.
    - name: Parse context
      id: ctx
      shell: bash
      env:
        PIPELINE_CONTEXT: ${{ inputs['pipeline-context'] }}
      run: |
        echo "language=$(echo "$PIPELINE_CONTEXT"  | jq -r '.language')"         >> "$GITHUB_OUTPUT"
        echo "version=$(echo "$PIPELINE_CONTEXT"   | jq -r '.version  // ""')"   >> "$GITHUB_OUTPUT"
        echo "context=$(echo "$PIPELINE_CONTEXT"   | jq -r '.context  // "."')"  >> "$GITHUB_OUTPUT"
        echo "command=$(echo "$PIPELINE_CONTEXT"   | jq -r '.command  // ""')"   >> "$GITHUB_OUTPUT"

    # ── Toolchain setup (one branch executes per matrix item) ─────────────────

    - name: Setup Go
      if: steps.ctx.outputs.language == 'go'
      uses: actions/setup-go@v5
      with:
        go-version: ${{ steps.ctx.outputs.version || '1.24' }}

    - name: Setup Rust
      if: steps.ctx.outputs.language == 'rust'
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ steps.ctx.outputs.version || 'stable' }}

    - name: Setup Python
      if: steps.ctx.outputs.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.ctx.outputs.version || '3.12' }}

    - name: Setup Node
      if: steps.ctx.outputs.language == 'node'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.ctx.outputs.version || '20' }}

    # ── Test execution ─────────────────────────────────────────────────────────

    - name: Run Tests (Go)
      if: steps.ctx.outputs.language == 'go'
      shell: bash
      working-directory: ${{ steps.ctx.outputs.context }}
      run: ${{ steps.ctx.outputs.command || 'go test -v ./...' }}

    - name: Run Tests (Rust)
      if: steps.ctx.outputs.language == 'rust'
      shell: bash
      working-directory: ${{ steps.ctx.outputs.context }}
      run: ${{ steps.ctx.outputs.command || 'cargo test' }}

    - name: Run Tests (Python)
      if: steps.ctx.outputs.language == 'python'
      shell: bash
      working-directory: ${{ steps.ctx.outputs.context }}
      run: |
        pip install -r requirements.txt || true
        pip install pytest
        ${{ steps.ctx.outputs.command || 'pytest' }}

    - name: Run Tests (Node)
      if: steps.ctx.outputs.language == 'node'
      shell: bash
      working-directory: ${{ steps.ctx.outputs.context }}
      run: |
        npm ci || npm install
        ${{ steps.ctx.outputs.command || 'npm test' }}
